angular.module("chatApp",["ng","ngRoute","ui.bootstrap"]).config(["$routeProvider",function(e){e.when("/login",{templateUrl:"/client/views/login.html",controller:"LoginController"}).when("/home",{templateUrl:"/client/views/home.html",controller:"HomeController"}).otherwise({redirectTo:"/home"})}]);
angular.module("chatApp").controller("HomeController",["$scope","$location","socket","dataFactory","$modal",function(e,o,n,t,s){e.connectedUser="",e.currentOpen={},e.currentTopic="Welcome",e.newRoomItem="",e.showRooms=!1,e.inputText="",e.openItems={},e.openTabs=[],e.rooms={},e.getRooms=function(){n.emit("rooms")},e.joinRoom=function(o){var t={room:o.name,pass:o.password};n.emit("joinroom",t,function(o,n){if(o){var s="Room-"+t.room,r={type:"Room",name:t.room,topic:"",messages:[],users:[],locked:!1};s in e.openItems||!t.pass||(r.locked=!0),e.openItems[s]=r,e.openTabs.push(s),e.currentOpen={ID:s},e.getRooms()}else"banned"===n?console.log("You are banned fcker !!!"):"wrong password"===n&&console.log("wrong password")})},e.sendText=function(){if(e.inputText&&"Room"===e.openItems[e.currentOpen.ID].type)return n.emit("sendmsg",{roomName:e.openItems[e.currentOpen.ID].name,msg:e.inputText}),void(e.inputText="");var o={message:e.inputText,nick:e.connectedUser};e.inputText&&"User"===e.openItems[e.currentOpen.ID].type&&n.emit("privatemsg",{nick:e.openItems[e.currentOpen.ID].chatWith,message:e.inputText},function(n){n?(e.inputText="",e.openItems[e.currentOpen.ID].messages.push(o)):console.log("couldnt send message")})},e.privateChat=function(o){if(o!==e.connectedUser){var n="User-"+o;if(e.openTabs.indexOf(n)>-1)return void(e.currentOpen.ID=n);var t={};t[o]=o,t[e.connectedUser]=e.connectedUser;var s={type:"User",name:o,topic:"Private Chat with "+o,messages:[],users:t,chatWith:o};n in e.openItems||(e.openItems[n]=s),e.currentOpen={ID:n},e.openTabs.push(n)}},n.on("roomlist",function(o){e.rooms=o}),n.on("updateusers",function(o,n,t){console.log("updateusers",o," - ",n," - ",t);var s="Room-"+o;if(s in e.openItems)return e.openItems[s].users=n,void(e.openItems[s].ops=t);var r="User-"+o;return r in e.openItems?(e.openItems[r].users=n,void(e.openItems[r].ops=t)):void 0}),n.on("updatetopic",function(o,n){var t="Room-"+o;t in e.openItems&&(e.openItems[t].topic=n)}),n.on("recv_privatemsg",function(o,n){var t="User-"+o,s={message:n,nick:o},r=[];if(r.push(s),t in e.openItems)e.openItems[t].messages.push(s);else{var m={};m[e.connectedUser]=e.connectedUser,m[o]=o;var c={type:"User",name:o,topic:"Private Chat with "+o,messages:r,users:m,chatWith:o};e.openItems[t]=c,e.openTabs.push(t)}}),n.on("servermessage",function(o,n,t){console.log("recv_privatemsg",o," - ",n," - ",t),e.getRooms()}),n.on("kicked",function(o,n){var t="Room-"+o;t in e.openItems&&n===e.connectedUser&&e.closeTab(t),e.getRooms()}),n.on("banned",function(o,n,t){console.log("banned",o,n,t);var s="Room-"+o;s in e.openItems&&n===e.connectedUser&&e.closeTab(s),e.getRooms()}),n.on("updatechat",function(o,n){var t="Room-"+o;t in e.openItems&&(e.openItems[t].messages=n),e.getRooms()}),e.show=function(o){e.showRooms=o},e.open=function(o){e.currentOpen.ID=o},e.closeTab=function(o){var t=0,s=0;if("Room"===e.openItems[o].type){t=e.openTabs.indexOf(o);var r=e.openItems[o].name;delete e.openItems[o],e.currentOpen.ID===o&&(s=t-1,e.currentOpen.ID=e.openTabs[s]),t>-1&&e.openTabs.splice(t,1),n.emit("partroom",r)}else t=e.openTabs.indexOf(o),e.currentOpen.ID===o&&(s=t-1,e.currentOpen.ID=e.openTabs[s]),t>-1&&e.openTabs.splice(t,1)},e.openChatRoom=function(o){var n={name:o},t="Room-"+o,s=e.openTabs.indexOf(t);return s>-1?void(e.currentOpen.ID=t):e.rooms[o].locked?void e.loginPassword(n):void e.joinRoom(n)},e.ban=function(o){n.emit("ban",{user:o,room:e.openItems[e.currentOpen.ID].name},function(){e.getRooms()})},e.kick=function(o){n.emit("kick",{user:o,room:e.openItems[e.currentOpen.ID].name})},e.createRoom=function(){var o=s.open({templateUrl:"/client/views/createRoomModal.html",controller:"ModalInstanceController"});o.result.then(function(o){e.newRoomItem=o,e.newRoomItem.name in e.rooms||(e.joinRoom(e.newRoomItem),e.newRoomItem="")})},e.loginPassword=function(o){var n=s.open({templateUrl:"/client/views/loginPassword.html",controller:"LoginInstanceController",resolve:{name:function(){return e.openItems[e.currentOpen.ID].name}}});n.result.then(function(n){o.password=n,e.joinRoom(o)})};var r=function(){if(e.connectedUser=t.getConnectedUser(),e.connectedUser){e.getRooms();var n={name:"lobby"};e.joinRoom(n)}else o.path("/login")};r()}]);
angular.module("chatApp").controller("LoginController",["$scope","$location","socket","dataFactory",function(e,o,n,r){e.login="login",e.user={username:""},e.connectedUser=r.getConnectedUser(),e.errors={available:!1},e.login=function(){n.emit("adduser",e.user.username,function(n){n?(r.setConnectedUser(e.user.username),o.path("/rooms")):e.errors.available=!0})}}]);
angular.module("chatApp").controller("LoginInstanceController",["$scope","$modalInstance","name",function(o,n,e){o.roomName=e,o.submitted=!1,o.ok=function(){return o.roomPassword?void n.close(o.roomPassword):void(o.submitted=!0)},o.cancel=function(){n.dismiss("cancel")}}]);
angular.module("chatApp").controller("ModalInstanceController",["$scope","$modalInstance",function(o,n){o.submitted=!1,o.newRoom={},o.ok=function(){return o.newRoom.name?void n.close(o.newRoom):void(o.submitted=!0)},o.cancel=function(){n.dismiss("cancel")}}]);
angular.module("chatApp").controller("RoomController",["$scope","$location","$routeParams","socket","dataFactory",function(o,e,t,n,r){o.connectedUser="",o.currentRoom=t.roomName,o.users={},o.inputText="",o.topic="",o.messages=[],o.sendText=function(){o.inputText&&(n.emit("sendmsg",{roomName:"lobby",msg:o.inputText}),o.inputText="")},o.toRooms=function(){n.emit("partroom",o.currentRoom),e.path("/rooms")},n.on("updateusers",function(e,t,n){console.log("updateusers",e," - ",t," - ",n),o.currentRoom===e&&(o.users=t)}),n.on("updatetopic",function(e,t){o.currentRoom===e&&(o.topic=t)}),n.on("servermessage",function(e,t){"join"===e&&o.currentRoom===t}),n.on("updatechat",function(e,t){o.currentRoom===e&&(o.messages=t)});var c=function(){o.connectedUser=r.getConnectedUser(),o.connectedUser||e.path("/login")};c()}]);
angular.module("chatApp").controller("RoomsController",["$scope","$location","socket","dataFactory",function(o,n,e,t){o.users=[],o.rooms=[],o.connectedUser="",o.getRooms=function(){e.emit("rooms")},o.joinRoom=function(o){var t={room:o};e.emit("joinroom",t,function(e,t){e?n.path("/room/"+o):console.log("Failed to join",t)})},e.on("roomlist",function(n){console.log("got roomlist"),o.rooms=n}),e.on("updateusers",function(o,n,e){console.log("updateusers",o," - ",n," - ",e)}),e.on("updatetopic",function(o,n,e){console.log("updatetopic",o," - ",n," - ",e)}),e.on("servermessage",function(o,n,e){console.log("servermessage",o," - ",n," - ",e)}),e.on("updatechat",function(o,n,e){console.log("updatechat",o," - ",n," - ",e)});var c=function(){o.connectedUser=t.getConnectedUser(),o.connectedUser||n.path("/login"),o.getRooms()};c()}]);
angular.module("chatApp").directive("chatScrollDirective",[function(){return{restrict:"A",link:function(c,t){$(t).focus()}}}]);
angular.module("chatApp").directive("enterDirective",[function(){return{restrict:"A",scope:{enter:"&"},link:function(e,n){$(n).bind("keypress",function(n){var r=n.keyCode||n.which;13==r&&e.enter()})}}}]);
angular.module("chatApp").directive("focusDirective",["$timeout","$parse",function(c){return{restrict:"A",link:function(o,t){o.$watch("focus",function(o){console.log("value",o),o===!0&&c(function(){$(t).focus()})}),o.focus=!0}}}]);
angular.module("chatApp").factory("dataFactory",[function(){var n="";return{setConnectedUser:function(t){n=t},getConnectedUser:function(){return n},logout:function(){n=""}}}]);
angular.module("chatApp").filter("usernameFilter",["dataFactory",function(e){return function(t){return t===e.getConnectedUser()?"You":t}}]);
angular.module("chatApp").factory("socket",["$rootScope",function(n){var t=io.connect("http://localhost:8080");return{on:function(o,a){t.on(o,function(){var o=arguments;n.$apply(function(){a.apply(t,o)})})},emit:function(o,a,c){t.emit(o,a,function(){var o=arguments;n.$apply(function(){c&&c.apply(t,o)})})}}}]);